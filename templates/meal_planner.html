{% extends "base.html" %}

{% block title %}Home | Kitchen App{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Weekly Meal Planner</h2>

    <form method="POST" action="{{ url_for('save_to_meal_planner') }}">
        {{ form.csrf_token() if form and form.csrf_token }}

        <div class="row mt-4 justify-content-center">
            <h3 class="text-center mb-3">Diet Information</h3>

            {% set diet_info = [
                ('Daily Calories', current_user.daily_calories, ''),
                ('Protein', current_user.protein_grams, 'g'),
                ('Fats', current_user.fat_grams, 'g'),
                ('Carbs', current_user.carbs_grams, 'g')
            ] %}
            {% for label, value, unit in diet_info %}
            <div class="col-md-3 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title"><strong>{{ label }}</strong></h6>
                        <p class="card-text fs-5">{{ value or "—" }} {{ unit }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row mb-3">
            <div class="col-md-4 mx-auto">
                <label for="selected_week" class="form-label"><strong>Select Week</strong></label>
                <select name="selected_week" id="selected_week" class="form-select"></select>
            </div>
        </div>

        <script>
            function formatDate(date) {
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: '2-digit' };
                return date.toLocaleDateString('en-US', options);
            }

            function getThisWeekMonday(date) {
                const day = date.getDay();
                const diff = (day === 0 ? -6 : 1 - day);
                const monday = new Date(date);
                monday.setDate(date.getDate() + diff);
                return monday;
            }

            function populateWeekOptions() {
                const select = document.getElementById('selected_week');
                const today = new Date();
                let monday = getThisWeekMonday(today);

                for (let i = 0; i < 8; i++) {
                    const startOfWeek = new Date(monday);
                    const endOfWeek = new Date(monday);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);

                    const option = document.createElement('option');
                    option.value = `${startOfWeek.toISOString().slice(0, 10)} to ${endOfWeek.toISOString().slice(0, 10)}`;
                    option.text = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
                    select.appendChild(option);

                    monday.setDate(monday.getDate() + 7);
                }
            }

            document.addEventListener('DOMContentLoaded', populateWeekOptions);
        </script>

        <div class="container mt-4">
            {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
            {% set meals = ['breakfast', 'lunch', 'snack', 'dinner', 'extra'] %}

            <div class="row g-4">
                {% for day in days %}
                {% if loop.index == 5 %}</div><div class="row g-4 mt-4">{% endif %}
                    <div class="col-md-3">
                        <label class="form-label"><strong>{{ day.capitalize() }}</strong></label>
                    
                        {% set daily_total = namespace(value=0) %}
                    
                        {% for meal in meals %}
                        <div class="row mb-2">
                            <div class="col-7">
                                <div class="form-control bg-light">
                                    <strong>{{ meal.capitalize() }}:</strong><br>
                                    {{ meal_data.get(day ~ '_' ~ meal, {}).get('name', '—') }}
                                </div>
                            </div>
                            <div class="col-5">
                                <div class="form-control bg-light text-end">
                                    <small>Calories:</small><br>
                                    {% set cal = meal_data.get(day ~ '_' ~ meal, {}).get('calories') %}
                                    {{ cal if cal else '—' }} kcal
                                    {% if cal %}
                                        {% set daily_total.value = daily_total.value + (cal | int) %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    
                        <div class="form-control text-center bg-warning-subtle mt-3">
                            <strong>Total Calories:</strong> {{ daily_total.value }} kcal
                        </div>
                    </div>
                                                        
                {% endfor %}

                <!-- Buttons -->
                <div class="col-md-3 d-flex flex-column align-items-end gap-2">
                    <br><br><br><br><br><br><br><br>
                    <button type="button" class="btn btn-secondary">Edit</button>
                    <button type="button" class="btn btn-info">Email</button>
                    <button type="button" class="btn btn-dark" onclick="window.print()">Print</button>
                </div>
            </div>
        </div>


    </form>
</div>
{% endblock %}