{% extends "base.html" %}

{% block title %}Grocery List{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center my-4">Grocery List</h2>

    <form action="/add" method="POST" class="mb-3">
        <div class="input-group">
            <input type="text" name="name" placeholder="Product" class="form-control" required>
            <input type="number" name="quantity" placeholder="Quantity" class="form-control">
            <button type="submit" class="btn btn-success">Add</button>
        </div>
    </form>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-outline-primary" onclick="toggleSelectAll()" id="select-all-btn">Select/Deselect All</button>
        <button class="btn btn-outline-danger" onclick="clearAllPurchased()">Clear All Purchased</button>
    </div>

    <ul class="list-group">
        {% for item in groceries %}
        <li class="list-group-item d-flex justify-content-between align-items-center" id="item-{{ item.id }}" 
            {% if item.purchased %}class="purchased-item"{% endif %}>
            <input type="checkbox" class="purchased-checkbox" 
                   onclick="togglePurchased({{ item.id }})" 
                   {% if item.purchased %}checked{% endif %}>
            
            <span id="item-{{ item.id }}-content" class="{{ 'strikethrough' if item.purchased else '' }}">
                <input type="text" id="name-{{ item.id }}" value="{{ item.name }}" 
                       class="form-control-sm item-input"
                       onchange="saveChanges({{ item.id }}, 'name')">

                <input type="number" id="quantity-{{ item.id }}" value="{{ item.quantity }}" 
                       class="form-control-sm item-input"
                       onchange="saveChanges({{ item.id }}, 'quantity')">
            </span>

            <a href="/delete/{{ item.id }}" class="btn btn-danger btn-sm">Delete</a>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
    function togglePurchased(itemId) {
        fetch(`/toggle_purchased/${itemId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let itemSpan = document.getElementById('item-' + itemId + '-content');
                itemSpan.classList.toggle('strikethrough', data.purchased); // Add or remove the strikethrough class
                // Also apply or remove line-through effect on input fields directly
                let inputs = itemSpan.querySelectorAll('input');
                inputs.forEach(input => {
                    input.classList.toggle('strikethrough-input', data.purchased);
                });
            }
        });
    }

    function saveChanges(itemId, field) {
        let value = document.getElementById(field + '-' + itemId).value.trim();
        let formData = new FormData();
        formData.append('new_' + field, value);

        fetch(`/rename/${itemId}`, { method: 'POST', body: formData })
        .then(response => response.json())
        .catch(error => console.error('Error:', error));
    }

    function clearAllPurchased() {
        fetch('/clear_all', { method: 'POST' })
        .then(() => location.reload());
    }

    function toggleSelectAll() {
        let checkboxes = document.querySelectorAll('.purchased-checkbox');
        let allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
            togglePurchased(checkbox.closest('li').id.split('-')[1]);  // Get the item ID from the list element
        });
    }
</script>

<style>
    .strikethrough {
        text-decoration: line-through;  /* Add line-through to span containing inputs */
    }

    .strikethrough-input {
        text-decoration: line-through;  /* Apply line-through effect to inputs (name and quantity) */
        background-color: #f2f2f2;  /* Optional: Change the background color to make it visually distinct */
    }
</style>

{% endblock %}
